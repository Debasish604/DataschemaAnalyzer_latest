{% extends "base.html" %}

{% block title %}Analysis Results - Data Analysis Tool{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Analysis Results</h2>
        <p class="text-muted mb-0">Session: {{ session.session_name }}</p>
        <small class="text-muted">
            Analyzed {{ session.file_count }} files • 
            {{ session.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </small>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
            <i data-feather="download"></i> Export Results
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('export_results', session_id=session.id, format='json') }}">
                <i data-feather="file-text"></i> JSON Report
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_results', session_id=session.id, format='csv') }}">
                <i data-feather="grid"></i> CSV Export
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_results', session_id=session.id, format='html') }}">
                <i data-feather="layout"></i> HTML Report
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('export_results', session_id=session.id, format='txt') }}">
                <i data-feather="file"></i> Text Report
            </a></li>
        </ul>
    </div>
</div>

<!-- Summary Cards -->
{% if results.summary %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i data-feather="file" style="width: 32px; height: 32px;" class="mb-2"></i>
                <h3 class="mb-1">{{ results.summary.total_files }}</h3>
                <p class="mb-0">Files Analyzed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i data-feather="database" style="width: 32px; height: 32px;" class="mb-2"></i>
                <h3 class="mb-1">{{ results.summary.total_rows }}</h3>
                <p class="mb-0">Total Rows</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i data-feather="columns" style="width: 32px; height: 32px;" class="mb-2"></i>
                <h3 class="mb-1">{{ results.summary.total_columns }}</h3>
                <p class="mb-0">Total Columns</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i data-feather="check-circle" style="width: 32px; height: 32px;" class="mb-2"></i>
                <h3 class="mb-1">{{ "%.1f"|format(results.summary.data_quality_score) }}%</h3>
                <p class="mb-0">Quality Score</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="data-types-tab" data-bs-toggle="tab" data-bs-target="#data-types" type="button">
            <i data-feather="type"></i> Data Types
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="patterns-tab" data-bs-toggle="tab" data-bs-target="#patterns" type="button">
            <i data-feather="trending-up"></i> Patterns
        </button>
    </li>
    {% if results.relationships %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="relationships-tab" data-bs-toggle="tab" data-bs-target="#relationships" type="button">
            <i data-feather="link"></i> Relationships
        </button>
    </li>
    {% endif %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button">
            <i data-feather="lightbulb"></i> Insights
        </button>
    </li>
</ul>

<div class="tab-content" id="analysisTabContent">
    <!-- Data Types Tab -->
    <div class="tab-pane fade show active" id="data-types" role="tabpanel">
        {% if results.data_types %}
            {% for filename, file_results in results.data_types.items() %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="file-text"></i> {{ filename }}
                        <span class="badge bg-secondary ms-2">{{ file_results|length }} columns</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Inferred Type</th>
                                    <th>Confidence</th>
                                    <th>Unique Values</th>
                                    <th>Missing</th>
                                    <th>Sample Values</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for column, analysis in file_results.items() %}
                                <tr>
                                    <td><strong>{{ column }}</strong></td>
                                    <td>
                                        <span class="badge bg-primary">{{ analysis.inferred_type }}</span>
                                        {% if analysis.characteristics %}
                                            <div class="small text-muted mt-1">
                                                {% for char in analysis.characteristics[:2] %}
                                                    <span class="badge bg-secondary me-1">{{ char }}</span>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" style="width: {{ (analysis.confidence * 100)|round }}%">
                                                {{ "%.1f"|format(analysis.confidence * 100) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ analysis.unique_count }}</td>
                                    <td>
                                        {% if analysis.null_count > 0 %}
                                            <span class="text-warning">{{ analysis.null_count }}</span>
                                        {% else %}
                                            <span class="text-success">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="small text-muted">
                                            {% for value in analysis.sample_values[:3] %}
                                                <code>{{ value }}</code>{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Patterns Tab -->
    <div class="tab-pane fade" id="patterns" role="tabpanel">
        {% if results.patterns %}
            {% for filename, pattern_data in results.patterns.items() %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="trending-up"></i> {{ filename }} - Pattern Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Outliers -->
                    {% if pattern_data.outliers %}
                    <div class="mb-4">
                        <h6><i data-feather="alert-triangle" class="text-warning"></i> Outliers Detected</h6>
                        <div class="row">
                            {% for column, outlier_info in pattern_data.outliers.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="border rounded p-3">
                                    <h6 class="mb-2">{{ column }}</h6>
                                    {% for method, details in outlier_info.items() %}
                                    <div class="small mb-2">
                                        <strong>{{ method.title() }}:</strong> 
                                        {{ details.count }} outliers ({{ "%.1f"|format(details.percentage) }}%)
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Data Quality -->
                    {% if pattern_data.data_quality %}
                    <div class="mb-4">
                        <h6><i data-feather="shield" class="text-info"></i> Data Quality Assessment</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-body-secondary">
                                    <div class="card-body">
                                        <h6>Completeness</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: {{ pattern_data.data_quality.completeness.score }}%">
                                                {{ "%.1f"|format(pattern_data.data_quality.completeness.score) }}%
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            {{ pattern_data.data_quality.completeness.missing_cells }} missing cells
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-body-secondary">
                                    <div class="card-body">
                                        <h6>Duplicates</h6>
                                        <p class="h5 text-warning mb-1">{{ pattern_data.data_quality.consistency.duplicate_rows.count }}</p>
                                        <small class="text-muted">
                                            {{ "%.1f"|format(pattern_data.data_quality.consistency.duplicate_rows.percentage) }}% of rows
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Correlations -->
                    {% if pattern_data.correlations and pattern_data.correlations.strong_correlations %}
                    <div class="mb-4">
                        <h6><i data-feather="activity" class="text-success"></i> Strong Correlations</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Column 1</th>
                                        <th>Column 2</th>
                                        <th>Correlation</th>
                                        <th>Strength</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for corr in pattern_data.correlations.strong_correlations %}
                                    <tr>
                                        <td>{{ corr.column1 }}</td>
                                        <td>{{ corr.column2 }}</td>
                                        <td>
                                            <span class="badge {% if corr.correlation > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ "%.3f"|format(corr.correlation) }}
                                            </span>
                                        </td>
                                        <td>{{ corr.strength }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Relationships Tab -->
    {% if results.relationships %}
    <div class="tab-pane fade" id="relationships" role="tabpanel">
        <div class="row">
            <!-- Potential Keys -->
            {% if results.relationships.potential_keys %}
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="key"></i> Potential Primary Keys
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for table_name, keys in results.relationships.potential_keys.items() %}
                        <div class="mb-3">
                            <h6>{{ table_name }}</h6>
                            {% if keys %}
                                {% for key in keys[:3] %}
                                <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                                    <div>
                                        <strong>{{ key.column }}</strong>
                                        <div class="small text-muted">{{ key.key_type }}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-primary">{{ "%.0f"|format(key.score) }}</span>
                                        <div class="small text-muted">{{ "%.1f"|format(key.uniqueness * 100) }}% unique</div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small">No strong primary key candidates found</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Join Suggestions -->
            {% if results.relationships.join_suggestions %}
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="link-2"></i> Recommended Joins
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for join in results.relationships.join_suggestions[:5] %}
                        <div class="border rounded p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ join.table1 }} ⟷ {{ join.table2 }}</h6>
                                    <p class="mb-1"><strong>Column:</strong> {{ join.join_column }}</p>
                                    <p class="mb-1"><strong>Join Type:</strong> 
                                        <span class="badge bg-info">{{ join.recommended_join_type }}</span>
                                    </p>
                                    <p class="small text-muted mb-0">{{ join.reasoning }}</p>
                                </div>
                                <div class="text-end">
                                    <div class="progress" style="width: 80px; height: 20px;">
                                        <div class="progress-bar" style="width: {{ (join.confidence * 100)|round }}%">
                                            {{ "%.0f"|format(join.confidence * 100) }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Table Relationships -->
        {% if results.relationships.relationships %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="shuffle"></i> Detected Relationships
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Table 1</th>
                                <th>Table 2</th>
                                <th>Column</th>
                                <th>Relationship Type</th>
                                <th>Strength</th>
                                <th>Common Values</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rel in results.relationships.relationships %}
                            <tr>
                                <td>{{ rel.table1 }}</td>
                                <td>{{ rel.table2 }}</td>
                                <td><code>{{ rel.column }}</code></td>
                                <td>
                                    <span class="badge bg-secondary">{{ rel.relationship_type.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" style="width: {{ (rel.strength * 100)|round }}%">
                                            {{ "%.1f"|format(rel.strength * 100) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ rel.values_in_common }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Insights Tab -->
    <div class="tab-pane fade" id="insights" role="tabpanel">
        {% if results.insights %}
            {% for filename, file_insights in results.insights.items() %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="lightbulb"></i> {{ filename }} - File Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dataset Overview</h6>
                            <ul class="list-unstyled">
                                <li><strong>Rows:</strong> {{ file_insights.row_count }}</li>
                                <li><strong>Columns:</strong> {{ file_insights.column_count }}</li>
                                <li><strong>Memory Usage:</strong> {{ "%.2f"|format(file_insights.memory_usage / 1024 / 1024) }} MB</li>
                                <li><strong>Duplicate Rows:</strong> {{ file_insights.duplicate_rows }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Column Types</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="h4 text-primary">{{ file_insights.numeric_columns|length }}</div>
                                        <div class="small">Numeric</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="h4 text-success">{{ file_insights.text_columns|length }}</div>
                                        <div class="small">Text</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if file_insights.missing_data %}
                    <div class="mt-4">
                        <h6>Missing Data by Column</h6>
                        <div class="row">
                            {% for column, missing_count in file_insights.missing_data.items() %}
                                {% if missing_count > 0 %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>{{ column }}</span>
                                        <span class="text-warning">{{ missing_count }} missing</span>
                                    </div>
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-warning" 
                                             style="width: {{ (missing_count / file_insights.row_count * 100)|round }}%"></div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Overall Recommendations -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="check-square"></i> Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Data Quality Improvements</h6>
                        <ul>
                            <li>Address missing values in key columns</li>
                            <li>Remove or investigate duplicate records</li>
                            <li>Standardize data formats across tables</li>
                            <li>Validate data type consistency</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Schema Optimization</h6>
                        <ul>
                            <li>Implement suggested primary keys</li>
                            <li>Create foreign key relationships</li>
                            <li>Consider data normalization opportunities</li>
                            <li>Optimize storage for large text fields</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Container for Visualizations -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Data Visualization</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <canvas id="analysisChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
<script>
    // Initialize analysis page
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        // Initialize any charts or interactive elements
        initializeAnalysis();
    });
</script>
{% endblock %}
